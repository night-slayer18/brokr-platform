# Brokr Platform - Complete Development Environment
# This file includes all services needed for testing the full platform
# 
# Quick Start:
# 1. docker-compose up -d
# 2. Access at http://localhost:8080
#
# Services included:
# - PostgreSQL Database
# - 3-node Kafka cluster (KRaft mode)
# - Schema Registry
# - Kafka Connect
# - ksqlDB
# - Brokr Platform Application (built from Dockerfile)

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: brokr-postgres
    environment:
      POSTGRES_DB: brokr
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka Broker 1 (KRaft mode)
  # NOTE: These Kafka services are OPTIONAL - only for testing/demo purposes
  # The Brokr platform connects to EXTERNAL Kafka clusters via bootstrap servers
  # configured by admins in the UI. This Kafka cluster is just for local testing.
  kafka-broker-1:
    image: confluentinc/cp-kafka:8.1.0
    container_name: brokr-kafka-1
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-broker-1:29093,2@kafka-broker-2:29093,3@kafka-broker-3:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://kafka-broker-1:29092,CONTROLLER://kafka-broker-1:29093,PLAINTEXT_HOST://0.0.0.0:9092'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka-broker-1:29092,PLAINTEXT_HOST://kafka-broker-1:9092'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_LOG_DIRS: '/var/lib/kafka/data'
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      CLUSTER_ID: '0K1NOVcqSoeQgUQc97lpzg'
    volumes:
      - kafka_data_1:/var/lib/kafka/data
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Kafka Broker 2
  kafka-broker-2:
    image: confluentinc/cp-kafka:8.1.0
    container_name: brokr-kafka-2
    ports:
      - "9093:9093"
    environment:
      KAFKA_NODE_ID: 2
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-broker-1:29093,2@kafka-broker-2:29093,3@kafka-broker-3:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://kafka-broker-2:29092,CONTROLLER://kafka-broker-2:29093,PLAINTEXT_HOST://0.0.0.0:9093'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka-broker-2:29092,PLAINTEXT_HOST://kafka-broker-2:9093'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_LOG_DIRS: '/var/lib/kafka/data'
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      CLUSTER_ID: '0K1NOVcqSoeQgUQc97lpzg'
    volumes:
      - kafka_data_2:/var/lib/kafka/data
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9093 || exit 1" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Kafka Broker 3
  kafka-broker-3:
    image: confluentinc/cp-kafka:8.1.0
    container_name: brokr-kafka-3
    ports:
      - "9094:9094"
    environment:
      KAFKA_NODE_ID: 3
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-broker-1:29093,2@kafka-broker-2:29093,3@kafka-broker-3:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://kafka-broker-3:29092,CONTROLLER://kafka-broker-3:29093,PLAINTEXT_HOST://0.0.0.0:9094'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka-broker-3:29092,PLAINTEXT_HOST://kafka-broker-3:9094'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_LOG_DIRS: '/var/lib/kafka/data'
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      CLUSTER_ID: '0K1NOVcqSoeQgUQc97lpzg'
    volumes:
      - kafka_data_3:/var/lib/kafka/data
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9094 || exit 1" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Schema Registry
  schema-registry:
    image: confluentinc/cp-schema-registry:8.1.0
    container_name: brokr-schema-registry
    depends_on:
      kafka-broker-1:
        condition: service_healthy
      kafka-broker-2:
        condition: service_healthy
      kafka-broker-3:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: 'kafka-broker-1:29092,kafka-broker-2:29092,kafka-broker-3:29092'
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_TOPIC_REPLICATION_FACTOR: 3
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8081/subjects || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka Connect
  kafka-connect:
    image: confluentinc/cp-kafka-connect:8.1.0
    container_name: brokr-kafka-connect
    depends_on:
      kafka-broker-1:
        condition: service_healthy
      kafka-broker-2:
        condition: service_healthy
      kafka-broker-3:
        condition: service_healthy
      schema-registry:
        condition: service_healthy
    ports:
      - "8083:8083"
    environment:
      CONNECT_BOOTSTRAP_SERVERS: 'kafka-broker-1:29092,kafka-broker-2:29092,kafka-broker-3:29092'
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: compose-connect-group
      CONNECT_CONFIG_STORAGE_TOPIC: docker-connect-configs
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_FLUSH_INTERVAL_MS: 10000
      CONNECT_OFFSET_STORAGE_TOPIC: docker-connect-offsets
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_TOPIC: docker-connect-status
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.storage.StringConverter
      CONNECT_VALUE_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      CONNECT_PLUGIN_PATH: "/usr/share/java,/usr/share/confluent-hub-components"
      # Enable REST API
      CONNECT_REST_LISTENERS: http://0.0.0.0:8083
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8083/connectors || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ksqlDB Server
  ksqldb-server:
    image: confluentinc/cp-ksqldb-server:latest
    container_name: brokr-ksqldb-server
    hostname: ksqldb-server
    depends_on:
      kafka-broker-1:
        condition: service_healthy
      kafka-broker-2:
        condition: service_healthy
      kafka-broker-3:
        condition: service_healthy
      schema-registry:
        condition: service_healthy
    ports:
      - "8088:8088"
    environment:
      KSQL_CONFIG_DIR: "/etc/ksql"
      KSQL_BOOTSTRAP_SERVERS: "kafka-broker-1:29092,kafka-broker-2:29092,kafka-broker-3:29092"
      KSQL_HOST_NAME: ksqldb-server
      KSQL_LISTENERS: "http://0.0.0.0:8088"
      KSQL_CACHE_MAX_BYTES_BUFFERING: 0
      KSQL_KSQL_SCHEMA_REGISTRY_URL: "http://schema-registry:8081"
      KSQL_PRODUCER_INTERCEPTOR_CLASSES: "io.confluent.monitoring.clients.interceptor.MonitoringProducerInterceptor"
      KSQL_CONSUMER_INTERCEPTOR_CLASSES: "io.confluent.monitoring.clients.interceptor.MonitoringConsumerInterceptor"
      KSQL_KSQL_CONNECT_URL: "http://kafka-connect:8083"
      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_REPLICATION_FACTOR: 3
      KSQL_KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE: 'true'
      KSQL_KSQL_LOGGING_PROCESSING_STREAM_AUTO_CREATE: 'true'
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8088/info || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Brokr Platform Application
  brokr-backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      # NOTE: Kafka services are NOT required - Brokr platform connects to external Kafka clusters
      # via bootstrap servers configured by admins in the UI. Kafka services above are only for local testing.
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/brokr
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: password
      SPRING_JPA_HIBERNATE_DDL_AUTO: validate
      SPRING_FLYWAY_ENABLED: "true"

      # JWT Configuration
      JWT_SECRET: XB0922J6WcWbXAgtFvmmebkfQUVMcjOqX4oag/xEHNY5E1MTFLQ2KSbqL52fmoGLHYCkkkJfzmGBB4vn6yYHlA==
      JWT_EXPIRATION: 86400

      # Security Configuration
      BCRYPT_STRENGTH: 10

      # MFA Configuration
      MFA_ENCRYPTION_KEY: toIUKBWfqdYUG+2COEOSzH88vXYmqTfJPpkwthZOwxA=
      MFA_TOTP_ISSUER: Brokr Platform
      MFA_BACKUP_CODES_COUNT: 10
      MFA_BACKUP_CODES_LENGTH: 8
      MFA_RATE_LIMIT_MAX_ATTEMPTS: 5
      MFA_RATE_LIMIT_WINDOW_MINUTES: 15
      MFA_RATE_LIMIT_LOCKOUT_MINUTES: 30

      # Message Replay Configuration
      MESSAGE_REPLAY_MAX_MESSAGES: 10000000
      MESSAGE_REPLAY_MAX_CONCURRENT: 5
      MESSAGE_REPLAY_PROGRESS_INTERVAL: 1000
      MESSAGE_REPLAY_TIMEOUT_MINUTES: 1440
      MESSAGE_REPLAY_STREAMING_BATCH: 10000
      MESSAGE_REPLAY_RATE_LIMIT: 0

      # API Key Configuration
      API_KEY_PREFIX: brokr_
      API_KEY_SECRET_LENGTH: 32
      API_KEY_DEFAULT_EXPIRATION_DAYS: 365
      API_KEY_ROTATION_GRACE_PERIOD_DAYS: 7
      API_KEY_RATE_LIMIT_PER_SECOND: 10
      API_KEY_RATE_LIMIT_PER_MINUTE: 100
      API_KEY_RATE_LIMIT_PER_HOUR: 1000
      API_KEY_RATE_LIMIT_PER_DAY: 10000
      API_KEY_USAGE_TRACKING_ENABLED: "true"
      API_KEY_USAGE_BATCH_SIZE: 100
      API_KEY_USAGE_BATCH_INTERVAL: 5
      API_KEY_USAGE_RETENTION_DAYS: 90
      API_KEY_BRUTE_FORCE_PROTECTION_ENABLED: "true"
      API_KEY_BRUTE_FORCE_MAX_ATTEMPTS: 5
      API_KEY_BRUTE_FORCE_LOCKOUT_MINUTES: 15
      API_KEY_SUSPICIOUS_ACTIVITY_ENABLED: "true"
      API_KEY_SUSPICIOUS_SPIKE_THRESHOLD: 10
      API_KEY_SUSPICIOUS_NEW_IP_ALERT: "true"

      # Logging Configuration
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_IO_BROKR: INFO
      LOGGING_LEVEL_IO_BROKR_KAFKA_SERVICE_KAFKACONSUMERSERVICE: INFO
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_GRAPHQL: INFO
      LOGGING_LEVEL_ORG_APACHE_KAFKA: WARN
    networks:
      - brokr-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  brokr-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  kafka_data_1:
    driver: local
  kafka_data_2:
    driver: local
  kafka_data_3:
    driver: local
